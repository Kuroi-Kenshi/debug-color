"use strict";
/**
 * Created by user on 2018/7/2/002.
 */
Object.defineProperty(exports, "__esModule", { value: true });
/// <reference types="node" />
const chalk_1 = require("chalk");
const luxon_1 = require("luxon");
const util = require("util");
const chk_1 = require("./chk");
const FillProperty = require("./fill-property");
const styles_1 = require("./styles");
const val_1 = require("./val");
const util_1 = require("./util");
class Console2 {
    constructor(target = console, options) {
        this[val_1.SYM_CONSOLE] = target || console;
        if (options && options.chalkOptions) {
            this[val_1.SYM_CHALK] = chalk_1.default.constructor(options.chalkOptions);
        }
        else {
            this[val_1.SYM_CHALK] = chalk_1.default.constructor();
        }
        // @ts-ignore
        this[val_1.SYM_DATA] = Object.create({
            colors: Object.create(val_1.defaultColors),
        });
        // @ts-ignore
        this[val_1.SYM_DATA].stream = !!(console._stdout && console._stderr);
        Object.assign(this[val_1.SYM_DATA], options || {});
        this[val_1.SYM_DATA].chalkOptions = this[val_1.SYM_DATA].chalkOptions || {};
        if (this[val_1.SYM_DATA].chalkOptions.enabled) {
            this[val_1.SYM_CHALK].enabled = true;
        }
        else if (this[val_1.SYM_CHALK].enabled && !chk_1.default()) {
            this[val_1.SYM_CHALK].enabled = false;
        }
        else if (!this[val_1.SYM_CHALK].enabled && util_1.isForceColor()) {
            this[val_1.SYM_CHALK].enabled = true;
        }
    }
    get chalk() {
        return this[val_1.SYM_CHALK];
    }
    set chalk(value) {
        this[val_1.SYM_CHALK] = value;
    }
    get levelColor() {
        return this[val_1.SYM_CHALK].level;
    }
    set levelColor(value) {
        this[val_1.SYM_CHALK].level = value;
    }
    get enabledColor() {
        return this[val_1.SYM_CHALK].enabled;
    }
    set enabledColor(value) {
        this[val_1.SYM_CHALK].enabled = value;
    }
    get chalkOptions() {
        return this[val_1.SYM_DATA].chalkOptions;
    }
    set chalkOptions(value) {
        this[val_1.SYM_DATA].chalkOptions = value;
    }
    get inspectOptions() {
        return this[val_1.SYM_DATA].inspectOptions;
    }
    set inspectOptions(value) {
        this[val_1.SYM_DATA].inspectOptions = value;
    }
    get enabled() {
        return this[val_1.SYM_DATA].enabled !== false;
    }
    set enabled(value) {
        this[val_1.SYM_DATA].enabled = value === true;
    }
    setOptions(options) {
        Object.assign(this[val_1.SYM_DATA], options);
        return this;
    }
    withOptions(options) {
        let o = this._clone();
        o[val_1.SYM_CHALK] = this[val_1.SYM_CHALK];
        o[val_1.SYM_DATA] = Object.assign({}, this[val_1.SYM_DATA], options);
        return o;
    }
    _clone() {
        const self = this;
        let o = function Console2Method(...argv) {
            // @ts-ignore
            return o.log(...argv);
        };
        /**
         * allow hacking parent object
         */
        // @ts-ignore
        //o.__proto__ = this.__proto__.constructor.prototype;
        o.__proto__ = this;
        //o = o.bind(o);
        o[val_1.SYM_CONSOLE] = self[val_1.SYM_CONSOLE];
        o[val_1.SYM_DATA] = self[val_1.SYM_DATA];
        // @ts-ignore
        return o;
    }
    _chalkStyleProp(name) {
        let o = this._clone();
        o[val_1.SYM_CHALK] = this[val_1.SYM_CHALK][name];
        return o;
    }
    _logFormat(format, ...args) {
        return util.format(format, ...args);
    }
    success(...argv) {
        return this._log('success', argv);
    }
    ok(...argv) {
        return this._log('ok', argv);
    }
    fail(...argv) {
        return this._log('fail', argv, 'error');
    }
    _log(name, argv, failBack = 'log') {
        if (!this.enabled) {
            return;
        }
        // @ts-ignore
        let s = this._logFormat(...argv);
        let o = this[val_1.SYM_CHALK](s);
        let arr = [];
        let data = this[val_1.SYM_DATA];
        if (data.time) {
            arr.push(this._time());
        }
        if (data.label) {
            let _ok = true;
            if (Array.isArray(data.label) && !data.label.includes(name)) {
                _ok = false;
            }
            _ok && arr.push(`[${name.toString().toUpperCase()}]`);
        }
        arr.push(o);
        if (arr.length && data.colors && data.colors[name]) {
            let c = data.colors[name];
            if (typeof c === 'string') {
                c = chalk_1.default[c];
            }
            arr = arr.map(v => c(v));
        }
        if (process.platform == 'win32' && this.enabledColor) {
            /**
             * @FIXME fix bug on windows when after bold
             *
             * https://github.com/chalk/chalk/issues/145#issuecomment-288985903
             */
            arr = arr.map(v => '\u001B[0m' + v + '\u001B[0m');
        }
        if (!(name in this[val_1.SYM_CONSOLE])) {
            name = failBack;
        }
        return this[val_1.SYM_CONSOLE][name](...arr);
    }
    _chalkStyleMethod(name) {
        return function chalkStyleMethod(...argv) {
            let o = this._clone();
            o[val_1.SYM_CHALK] = this[val_1.SYM_CHALK][name](...argv);
            return o;
        };
    }
    _time() {
        return luxon_1.DateTime.local().toFormat('[HH:mm:ss.SSS]');
    }
}
exports.Console2 = Console2;
util.inherits(Console2, Function);
// @ts-ignore
Console2.prototype.Console = Console2;
styles_1.styleNames.forEach(function (name) {
    if (styles_1.styleNamesFn.includes(name)) {
        Object.defineProperty(Console2.prototype, name, {
            get() {
                return this._chalkStyleMethod(name);
            },
        });
    }
    else {
        Object.defineProperty(Console2.prototype, name, {
            get() {
                return this._chalkStyleProp(name);
            },
        });
    }
});
FillProperty.methods.forEach(function (name) {
    if (name == 'dir') {
        Console2.prototype[name] = function chalkStyleLogOthers(object, options) {
            if (!this.enabled) {
                return;
            }
            if (!options && this[val_1.SYM_DATA].inspectOptions) {
                options = this[val_1.SYM_DATA].inspectOptions;
            }
            if (options) {
                return this[val_1.SYM_CONSOLE][name](object, options);
            }
            return this[val_1.SYM_CONSOLE][name](object);
        };
    }
    else if (name == 'assert') {
        Console2.prototype[name] = function chalkStyleLogAssert(value, ...argv) {
            if (!this.enabled) {
                return;
            }
            if (!value) {
                let o;
                if (argv.length) {
                    let s = this._logFormat(...argv);
                    o = this[val_1.SYM_CHALK](s);
                }
                return this[val_1.SYM_CONSOLE][name](value, o);
            }
        };
    }
    else if (FillProperty.methods_stdout.includes(name)) {
        Console2.prototype[name] = function chalkStyleLog(...argv) {
            return this._log(name, argv);
        };
    }
    else if (FillProperty.methods_stderr.includes(name)) {
        Console2.prototype[name] = function chalkStyleLog(...argv) {
            return this._log(name, argv, 'error');
        };
    }
    else {
        Console2.prototype[name] = function chalkStyleLogOthers(...argv) {
            if (!this.enabled) {
                return;
            }
            return this[val_1.SYM_CONSOLE][name](...argv);
        };
    }
});
exports.default = Console2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILDhCQUE4QjtBQUU5QixpQ0FBMEQ7QUFFMUQsaUNBQWlDO0FBQ2pDLDZCQUE4QjtBQUM5QiwrQkFBNkI7QUFDN0IsZ0RBQWlEO0FBQ2pELHFDQUE2RDtBQUM3RCwrQkFBa0Y7QUFDbEYsaUNBQXNDO0FBOEd0QyxNQUFhLFFBQVE7SUFFcEIsWUFBWSxNQUFNLEdBQUcsT0FBTyxFQUFFLE9BQWtCO1FBRS9DLElBQUksQ0FBQyxpQkFBVyxDQUFDLEdBQUcsTUFBTSxJQUFJLE9BQU8sQ0FBQztRQUV0QyxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsWUFBWSxFQUNuQztZQUNDLElBQUksQ0FBQyxlQUFTLENBQUMsR0FBRyxlQUFLLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUMxRDthQUVEO1lBQ0MsSUFBSSxDQUFDLGVBQVMsQ0FBQyxHQUFHLGVBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUN0QztRQUVELGFBQWE7UUFDYixJQUFJLENBQUMsY0FBUSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUM5QixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxtQkFBYSxDQUFDO1NBQ3BDLENBQUMsQ0FBQztRQUVILGFBQWE7UUFDYixJQUFJLENBQUMsY0FBUSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRS9ELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQVEsQ0FBQyxFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQztRQUU3QyxJQUFJLENBQUMsY0FBUSxDQUFDLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxjQUFRLENBQUMsQ0FBQyxZQUFZLElBQUks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QyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBUyxtQkFBbUIsQ0FBQyxHQUFHLElBQUk7WUFFOUQsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQ2pCO2dCQUNDLE9BQU87YUFDUDtZQUVELE9BQU8sSUFBSSxDQUFDLGlCQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQztLQUNGO0FBQ0YsQ0FBQyxDQUFDLENBQUM7QUFFSCxrQkFBZSxRQUFRLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzcvMi8wMDIuXG4gKi9cblxuLy8vIDxyZWZlcmVuY2UgdHlwZXM9XCJub2RlXCIgLz5cblxuaW1wb3J0IGNoYWxrLCB7IENoYWxrLCBMZXZlbCwgQ2hhbGtPcHRpb25zIH0gZnJvbSAnY2hhbGsnO1xuaW1wb3J0IHsgQ29uc29sZSB9IGZyb20gJ2NvbnNvbGUnO1xuaW1wb3J0IHsgRGF0ZVRpbWUgfSBmcm9tICdsdXhvbic7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbmltcG9ydCBpc05vZGVKcyBmcm9tICcuL2Noayc7XG5pbXBvcnQgRmlsbFByb3BlcnR5ID0gcmVxdWlyZSgnLi9maWxsLXByb3BlcnR5Jyk7XG5pbXBvcnQgeyBJU3R5bGVzLCBzdHlsZU5hbWVzLCBzdHlsZU5hbWVzRm4gfSBmcm9tICcuL3N0eWxlcyc7XG5pbXBvcnQgeyBkZWZhdWx0Q29sb3JzLCBJT3B0aW9ucywgU1lNX0NIQUxLLCBTWU1fQ09OU09MRSwgU1lNX0RBVEEgfSBmcm9tICcuL3ZhbCc7XG5pbXBvcnQgeyBpc0ZvcmNlQ29sb3IgfSBmcm9tICcuL3V0aWwnO1xuXG5leHBvcnQgeyBJbnNwZWN0T3B0aW9ucyB9IGZyb20gJ3V0aWwnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbnNvbGUyIGV4dGVuZHMgQ29uc29sZSwgSVN0eWxlc1xue1xuXHQoLi4uYXJndik6IHZvaWRcblxuXHRbU1lNX0NPTlNPTEVdOiBDb25zb2xlO1xuXHRbU1lNX0NIQUxLXTogQ2hhbGs7XG5cblx0W1NZTV9EQVRBXTogSU9wdGlvbnNcblxuXHQvKipcblx0ICogQSBzaW1wbGUgYXNzZXJ0aW9uIHRlc3QgdGhhdCB2ZXJpZmllcyB3aGV0aGVyIGB2YWx1ZWAgaXMgdHJ1dGh5LlxuXHQgKiBJZiBpdCBpcyBub3QsIGFuIGBBc3NlcnRpb25FcnJvcmAgaXMgdGhyb3duLlxuXHQgKiBJZiBwcm92aWRlZCwgdGhlIGVycm9yIGBtZXNzYWdlYCBpcyBmb3JtYXR0ZWQgdXNpbmcgYHV0aWwuZm9ybWF0KClgIGFuZCB1c2VkIGFzIHRoZSBlcnJvciBtZXNzYWdlLlxuXHQgKi9cblx0YXNzZXJ0KHZhbHVlOiBhbnksIG1lc3NhZ2U/OiBzdHJpbmcsIC4uLm9wdGlvbmFsUGFyYW1zOiBhbnlbXSk6IHZvaWQ7XG5cdC8qKlxuXHQgKiBXaGVuIGBzdGRvdXRgIGlzIGEgVFRZLCBjYWxsaW5nIGBjb25zb2xlLmNsZWFyKClgIHdpbGwgYXR0ZW1wdCB0byBjbGVhciB0aGUgVFRZLlxuXHQgKiBXaGVuIGBzdGRvdXRgIGlzIG5vdCBhIFRUWSwgdGhpcyBtZXRob2QgZG9lcyBub3RoaW5nLlxuXHQgKi9cblx0Y2xlYXIoKTogdm9pZDtcblx0LyoqXG5cdCAqIE1haW50YWlucyBhbiBpbnRlcm5hbCBjb3VudGVyIHNwZWNpZmljIHRvIGBsYWJlbGAgYW5kIG91dHB1dHMgdG8gYHN0ZG91dGAgdGhlIG51bWJlciBvZiB0aW1lcyBgY29uc29sZS5jb3VudCgpYCBoYXMgYmVlbiBjYWxsZWQgd2l0aCB0aGUgZ2l2ZW4gYGxhYmVsYC5cblx0ICovXG5cdGNvdW50KGxhYmVsPzogc3RyaW5nKTogdm9pZDtcblx0LyoqXG5cdCAqIFJlc2V0cyB0aGUgaW50ZXJuYWwgY291bnRlciBzcGVjaWZpYyB0byBgbGFiZWxgLlxuXHQgKi9cblx0Y291bnRSZXNldChsYWJlbD86IHN0cmluZyk6IHZvaWQ7XG5cdC8qKlxuXHQgKiBUaGUgYGNvbnNvbGUuZGVidWcoKWAgZnVuY3Rpb24gaXMgYW4gYWxpYXMgZm9yIHtAbGluayBjb25zb2xlLmxvZygpfS5cblx0ICovXG5cdGRlYnVnKG1lc3NhZ2U/OiBhbnksIC4uLm9wdGlvbmFsUGFyYW1zOiBhbnlbXSk6IHZvaWQ7XG5cdC8qKlxuXHQgKiBVc2VzIHtAbGluayB1dGlsLmluc3BlY3QoKX0gb24gYG9iamAgYW5kIHByaW50cyB0aGUgcmVzdWx0aW5nIHN0cmluZyB0byBgc3Rkb3V0YC5cblx0ICogVGhpcyBmdW5jdGlvbiBieXBhc3NlcyBhbnkgY3VzdG9tIGBpbnNwZWN0KClgIGZ1bmN0aW9uIGRlZmluZWQgb24gYG9iamAuXG5cdCAqL1xuXHRkaXIob2JqOiBhbnksIG9wdGlvbnM/OiBOb2RlSlMuSW5zcGVjdE9wdGlvbnMpOiB2b2lkO1xuXHQvKipcblx0ICogVGhpcyBtZXRob2QgY2FsbHMge0BsaW5rIGNvbnNvbGUubG9nKCl9IHBhc3NpbmcgaXQgdGhlIGFyZ3VtZW50cyByZWNlaXZlZC4gUGxlYXNlIG5vdGUgdGhhdCB0aGlzIG1ldGhvZCBkb2VzIG5vdCBwcm9kdWNlIGFueSBYTUwgZm9ybWF0dGluZ1xuXHQgKi9cblx0ZGlyeG1sKC4uLmRhdGE6IGFueVtdKTogdm9pZDtcblx0LyoqXG5cdCAqIFByaW50cyB0byBgc3RkZXJyYCB3aXRoIG5ld2xpbmUuXG5cdCAqL1xuXHRlcnJvcihtZXNzYWdlPzogYW55LCAuLi5vcHRpb25hbFBhcmFtczogYW55W10pOiB2b2lkO1xuXHQvKipcblx0ICogSW5jcmVhc2VzIGluZGVudGF0aW9uIG9mIHN1YnNlcXVlbnQgbGluZXMgYnkgdHdvIHNwYWNlcy5cblx0ICogSWYgb25lIG9yIG1vcmUgYGxhYmVsYHMgYXJlIHByb3ZpZGVkLCB0aG9zZSBhcmUgcHJpbnRlZCBmaXJzdCB3aXRob3V0IHRoZSBhZGRpdGlvbmFsIGluZGVudGF0aW9uLlxuXHQgKi9cblx0Z3JvdXAoLi4ubGFiZWw6IGFueVtdKTogdm9pZDtcblx0LyoqXG5cdCAqIFRoZSBgY29uc29sZS5ncm91cENvbGxhcHNlZCgpYCBmdW5jdGlvbiBpcyBhbiBhbGlhcyBmb3Ige0BsaW5rIGNvbnNvbGUuZ3JvdXAoKX0uXG5cdCAqL1xuXHRncm91cENvbGxhcHNlZCgpOiB2b2lkO1xuXHQvKipcblx0ICogRGVjcmVhc2VzIGluZGVudGF0aW9uIG9mIHN1YnNlcXVlbnQgbGluZXMgYnkgdHdvIHNwYWNlcy5cblx0ICovXG5cdGdyb3VwRW5kKCk6IHZvaWQ7XG5cdC8qKlxuXHQgKiBUaGUge0BsaW5rIGNvbnNvbGUuaW5mbygpfSBmdW5jdGlvbiBpcyBhbiBhbGlhcyBmb3Ige0BsaW5rIGNvbnNvbGUubG9nKCl9LlxuXHQgKi9cblx0aW5mbyhtZXNzYWdlPzogYW55LCAuLi5vcHRpb25hbFBhcmFtczogYW55W10pOiB2b2lkO1xuXHQvKipcblx0ICogUHJpbnRzIHRvIGBzdGRvdXRgIHdpdGggbmV3bGluZS5cblx0ICovXG5cdGxvZyhtZXNzYWdlPzogYW55LCAuLi5vcHRpb25hbFBhcmFtczogYW55W10pOiB2b2lkO1xuXHQvKipcblx0ICogVGhpcyBtZXRob2QgZG9lcyBub3QgZGlzcGxheSBhbnl0aGluZyB1bmxlc3MgdXNlZCBpbiB0aGUgaW5zcGVjdG9yLlxuXHQgKiAgUHJpbnRzIHRvIGBzdGRvdXRgIHRoZSBhcnJheSBgYXJyYXlgIGZvcm1hdHRlZCBhcyBhIHRhYmxlLlxuXHQgKi9cblx0dGFibGUodGFidWxhckRhdGE6IGFueSwgcHJvcGVydGllcz86IHN0cmluZ1tdKTogdm9pZDtcblx0LyoqXG5cdCAqIFN0YXJ0cyBhIHRpbWVyIHRoYXQgY2FuIGJlIHVzZWQgdG8gY29tcHV0ZSB0aGUgZHVyYXRpb24gb2YgYW4gb3BlcmF0aW9uLiBUaW1lcnMgYXJlIGlkZW50aWZpZWQgYnkgYSB1bmlxdWUgYGxhYmVsYC5cblx0ICovXG5cdHRpbWUobGFiZWw/OiBzdHJpbmcpOiB2b2lkO1xuXHQvKipcblx0ICogU3RvcHMgYSB0aW1lciB0aGF0IHdhcyBwcmV2aW91c2x5IHN0YXJ0ZWQgYnkgY2FsbGluZyB7QGxpbmsgY29uc29sZS50aW1lKCl9IGFuZCBwcmludHMgdGhlIHJlc3VsdCB0byBgc3Rkb3V0YC5cblx0ICovXG5cdHRpbWVFbmQobGFiZWw/OiBzdHJpbmcpOiB2b2lkO1xuXHQvKipcblx0ICogUHJpbnRzIHRvIGBzdGRlcnJgIHRoZSBzdHJpbmcgJ1RyYWNlIDonLCBmb2xsb3dlZCBieSB0aGUge0BsaW5rIHV0aWwuZm9ybWF0KCl9IGZvcm1hdHRlZCBtZXNzYWdlIGFuZCBzdGFjayB0cmFjZSB0byB0aGUgY3VycmVudCBwb3NpdGlvbiBpbiB0aGUgY29kZS5cblx0ICovXG5cdHRyYWNlKG1lc3NhZ2U/OiBhbnksIC4uLm9wdGlvbmFsUGFyYW1zOiBhbnlbXSk6IHZvaWQ7XG5cdC8qKlxuXHQgKiBUaGUge0BsaW5rIGNvbnNvbGUud2FybigpfSBmdW5jdGlvbiBpcyBhbiBhbGlhcyBmb3Ige0BsaW5rIGNvbnNvbGUuZXJyb3IoKX0uXG5cdCAqL1xuXHR3YXJuKG1lc3NhZ2U/OiBhbnksIC4uLm9wdGlvbmFsUGFyYW1zOiBhbnlbXSk6IHZvaWQ7XG5cblx0Ly8gLS0tIEluc3BlY3RvciBtb2RlIG9ubHkgLS0tXG5cdC8qKlxuXHQgKiBUaGlzIG1ldGhvZCBkb2VzIG5vdCBkaXNwbGF5IGFueXRoaW5nIHVubGVzcyB1c2VkIGluIHRoZSBpbnNwZWN0b3IuXG5cdCAqICBTdGFydHMgYSBKYXZhU2NyaXB0IENQVSBwcm9maWxlIHdpdGggYW4gb3B0aW9uYWwgbGFiZWwuXG5cdCAqL1xuXHRwcm9maWxlKGxhYmVsPzogc3RyaW5nKTogdm9pZDtcblx0LyoqXG5cdCAqIFRoaXMgbWV0aG9kIGRvZXMgbm90IGRpc3BsYXkgYW55dGhpbmcgdW5sZXNzIHVzZWQgaW4gdGhlIGluc3BlY3Rvci5cblx0ICogIFN0b3BzIHRoZSBjdXJyZW50IEphdmFTY3JpcHQgQ1BVIHByb2ZpbGluZyBzZXNzaW9uIGlmIG9uZSBoYXMgYmVlbiBzdGFydGVkIGFuZCBwcmludHMgdGhlIHJlcG9ydCB0byB0aGUgUHJvZmlsZXMgcGFuZWwgb2YgdGhlIGluc3BlY3Rvci5cblx0ICovXG5cdHByb2ZpbGVFbmQoKTogdm9pZDtcblx0LyoqXG5cdCAqIFRoaXMgbWV0aG9kIGRvZXMgbm90IGRpc3BsYXkgYW55dGhpbmcgdW5sZXNzIHVzZWQgaW4gdGhlIGluc3BlY3Rvci5cblx0ICogIEFkZHMgYW4gZXZlbnQgd2l0aCB0aGUgbGFiZWwgYGxhYmVsYCB0byB0aGUgVGltZWxpbmUgcGFuZWwgb2YgdGhlIGluc3BlY3Rvci5cblx0ICovXG5cdHRpbWVTdGFtcChsYWJlbD86IHN0cmluZyk6IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBDb25zb2xlMlxue1xuXHRjb25zdHJ1Y3Rvcih0YXJnZXQgPSBjb25zb2xlLCBvcHRpb25zPzogSU9wdGlvbnMpXG5cdHtcblx0XHR0aGlzW1NZTV9DT05TT0xFXSA9IHRhcmdldCB8fCBjb25zb2xlO1xuXG5cdFx0aWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jaGFsa09wdGlvbnMpXG5cdFx0e1xuXHRcdFx0dGhpc1tTWU1fQ0hBTEtdID0gY2hhbGsuY29uc3RydWN0b3Iob3B0aW9ucy5jaGFsa09wdGlvbnMpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0dGhpc1tTWU1fQ0hBTEtdID0gY2hhbGsuY29uc3RydWN0b3IoKTtcblx0XHR9XG5cblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0dGhpc1tTWU1fREFUQV0gPSBPYmplY3QuY3JlYXRlKHtcblx0XHRcdGNvbG9yczogT2JqZWN0LmNyZWF0ZShkZWZhdWx0Q29sb3JzKSxcblx0XHR9KTtcblxuXHRcdC8vIEB0cy1pZ25vcmVcblx0XHR0aGlzW1NZTV9EQVRBXS5zdHJlYW0gPSAhIShjb25zb2xlLl9zdGRvdXQgJiYgY29uc29sZS5fc3RkZXJyKTtcblxuXHRcdE9iamVjdC5hc3NpZ24odGhpc1tTWU1fREFUQV0sIG9wdGlvbnMgfHwge30pO1xuXG5cdFx0dGhpc1tTWU1fREFUQV0uY2hhbGtPcHRpb25zID0gdGhpc1tTWU1fREFUQV0uY2hhbGtPcHRpb25zIHx8IHt9O1xuXG5cdFx0aWYgKHRoaXNbU1lNX0RBVEFdLmNoYWxrT3B0aW9ucy5lbmFibGVkKVxuXHRcdHtcblx0XHRcdHRoaXNbU1lNX0NIQUxLXS5lbmFibGVkID0gdHJ1ZTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAodGhpc1tTWU1fQ0hBTEtdLmVuYWJsZWQgJiYgIWlzTm9kZUpzKCkpXG5cdFx0e1xuXHRcdFx0dGhpc1tTWU1fQ0hBTEtdLmVuYWJsZWQgPSBmYWxzZTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAoIXRoaXNbU1lNX0NIQUxLXS5lbmFibGVkICYmIGlzRm9yY2VDb2xvcigpKVxuXHRcdHtcblx0XHRcdHRoaXNbU1lNX0NIQUxLXS5lbmFibGVkID0gdHJ1ZTtcblx0XHR9XG5cdH1cblxuXHRnZXQgY2hhbGsoKVxuXHR7XG5cdFx0cmV0dXJuIHRoaXNbU1lNX0NIQUxLXVxuXHR9XG5cblx0c2V0IGNoYWxrKHZhbHVlKVxuXHR7XG5cdFx0dGhpc1tTWU1fQ0hBTEtdID0gdmFsdWVcblx0fVxuXG5cdGdldCBsZXZlbENvbG9yKCk6IExldmVsXG5cdHtcblx0XHRyZXR1cm4gdGhpc1tTWU1fQ0hBTEtdLmxldmVsXG5cdH1cblxuXHRzZXQgbGV2ZWxDb2xvcih2YWx1ZSlcblx0e1xuXHRcdHRoaXNbU1lNX0NIQUxLXS5sZXZlbCA9IHZhbHVlXG5cdH1cblxuXHRnZXQgZW5hYmxlZENvbG9yKClcblx0e1xuXHRcdHJldHVybiB0aGlzW1NZTV9DSEFMS10uZW5hYmxlZFxuXHR9XG5cblx0c2V0IGVuYWJsZWRDb2xvcih2YWx1ZSlcblx0e1xuXHRcdHRoaXNbU1lNX0NIQUxLXS5lbmFibGVkID0gdmFsdWVcblx0fVxuXG5cdGdldCBjaGFsa09wdGlvbnMoKVxuXHR7XG5cdFx0cmV0dXJuIHRoaXNbU1lNX0RBVEFdLmNoYWxrT3B0aW9uc1xuXHR9XG5cblx0c2V0IGNoYWxrT3B0aW9ucyh2YWx1ZSlcblx0e1xuXHRcdHRoaXNbU1lNX0RBVEFdLmNoYWxrT3B0aW9ucyA9IHZhbHVlXG5cdH1cblxuXHRnZXQgaW5zcGVjdE9wdGlvbnMoKVxuXHR7XG5cdFx0cmV0dXJuIHRoaXNbU1lNX0RBVEFdLmluc3BlY3RPcHRpb25zXG5cdH1cblxuXHRzZXQgaW5zcGVjdE9wdGlvbnModmFsdWUpXG5cdHtcblx0XHR0aGlzW1NZTV9EQVRBXS5pbnNwZWN0T3B0aW9ucyA9IHZhbHVlXG5cdH1cblxuXHRnZXQgZW5hYmxlZCgpXG5cdHtcblx0XHRyZXR1cm4gdGhpc1tTWU1fREFUQV0uZW5hYmxlZCAhPT0gZmFsc2Vcblx0fVxuXG5cdHNldCBlbmFibGVkKHZhbHVlKVxuXHR7XG5cdFx0dGhpc1tTWU1fREFUQV0uZW5hYmxlZCA9IHZhbHVlID09PSB0cnVlXG5cdH1cblxuXHRzZXRPcHRpb25zKG9wdGlvbnM6IElPcHRpb25zKVxuXHR7XG5cdFx0T2JqZWN0LmFzc2lnbih0aGlzW1NZTV9EQVRBXSwgb3B0aW9ucyk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHdpdGhPcHRpb25zKG9wdGlvbnM6IElPcHRpb25zKVxuXHR7XG5cdFx0bGV0IG8gPSB0aGlzLl9jbG9uZSgpO1xuXG5cdFx0b1tTWU1fQ0hBTEtdID0gdGhpc1tTWU1fQ0hBTEtdO1xuXG5cdFx0b1tTWU1fREFUQV0gPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzW1NZTV9EQVRBXSwgb3B0aW9ucyk7XG5cblx0XHRyZXR1cm4gbztcblx0fVxuXG5cdHByb3RlY3RlZCBfY2xvbmUoKTogdGhpc1xuXHR7XG5cdFx0Y29uc3Qgc2VsZiA9IHRoaXM7XG5cblx0XHRsZXQgbyA9IGZ1bmN0aW9uIENvbnNvbGUyTWV0aG9kKC4uLmFyZ3YpXG5cdFx0e1xuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0cmV0dXJuIG8ubG9nKC4uLmFyZ3YpO1xuXHRcdH07XG5cblx0XHQvKipcblx0XHQgKiBhbGxvdyBoYWNraW5nIHBhcmVudCBvYmplY3Rcblx0XHQgKi9cblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0Ly9vLl9fcHJvdG9fXyA9IHRoaXMuX19wcm90b19fLmNvbnN0cnVjdG9yLnByb3RvdHlwZTtcblx0XHRvLl9fcHJvdG9fXyA9IHRoaXM7XG5cblx0XHQvL28gPSBvLmJpbmQobyk7XG5cblx0XHRvW1NZTV9DT05TT0xFXSA9IHNlbGZbU1lNX0NPTlNPTEVdO1xuXHRcdG9bU1lNX0RBVEFdID0gc2VsZltTWU1fREFUQV07XG5cblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0cmV0dXJuIG87XG5cdH1cblxuXHRwcm90ZWN0ZWQgX2NoYWxrU3R5bGVQcm9wKG5hbWUpXG5cdHtcblx0XHRsZXQgbyA9IHRoaXMuX2Nsb25lKCk7XG5cdFx0b1tTWU1fQ0hBTEtdID0gdGhpc1tTWU1fQ0hBTEtdW25hbWVdO1xuXHRcdHJldHVybiBvO1xuXHR9XG5cblx0cHJvdGVjdGVkIF9sb2dGb3JtYXQoZm9ybWF0LCAuLi5hcmdzKVxuXHR7XG5cdFx0cmV0dXJuIHV0aWwuZm9ybWF0KGZvcm1hdCwgLi4uYXJncyk7XG5cdH1cblxuXHRzdWNjZXNzKC4uLmFyZ3YpXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fbG9nKCdzdWNjZXNzJywgYXJndik7XG5cdH1cblxuXHRvayguLi5hcmd2KVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX2xvZygnb2snLCBhcmd2KTtcblx0fVxuXG5cdGZhaWwoLi4uYXJndilcblx0e1xuXHRcdHJldHVybiB0aGlzLl9sb2coJ2ZhaWwnLCBhcmd2LCAnZXJyb3InKTtcblx0fVxuXG5cdHByb3RlY3RlZCBfbG9nKG5hbWU6IHN0cmluZywgYXJndiwgZmFpbEJhY2sgPSAnbG9nJylcblx0e1xuXHRcdGlmICghdGhpcy5lbmFibGVkKVxuXHRcdHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHQvLyBAdHMtaWdub3JlXG5cdFx0bGV0IHMgPSB0aGlzLl9sb2dGb3JtYXQoLi4uYXJndik7XG5cdFx0bGV0IG8gPSB0aGlzW1NZTV9DSEFMS10ocyk7XG5cblx0XHRsZXQgYXJyID0gW107XG5cblx0XHRsZXQgZGF0YSA9IHRoaXNbU1lNX0RBVEFdO1xuXG5cdFx0aWYgKGRhdGEudGltZSlcblx0XHR7XG5cdFx0XHRhcnIucHVzaCh0aGlzLl90aW1lKCkpO1xuXHRcdH1cblxuXHRcdGlmIChkYXRhLmxhYmVsKVxuXHRcdHtcblx0XHRcdGxldCBfb2sgPSB0cnVlO1xuXG5cdFx0XHRpZiAoQXJyYXkuaXNBcnJheShkYXRhLmxhYmVsKSAmJiAhZGF0YS5sYWJlbC5pbmNsdWRlcyhuYW1lKSlcblx0XHRcdHtcblx0XHRcdFx0X29rID0gZmFsc2U7XG5cdFx0XHR9XG5cblx0XHRcdF9vayAmJiBhcnIucHVzaChgWyR7bmFtZS50b1N0cmluZygpLnRvVXBwZXJDYXNlKCl9XWApO1xuXHRcdH1cblxuXHRcdGFyci5wdXNoKG8pO1xuXG5cdFx0aWYgKGFyci5sZW5ndGggJiYgZGF0YS5jb2xvcnMgJiYgZGF0YS5jb2xvcnNbbmFtZV0pXG5cdFx0e1xuXHRcdFx0bGV0IGM6IGFueSA9IGRhdGEuY29sb3JzW25hbWVdO1xuXG5cdFx0XHRpZiAodHlwZW9mIGMgPT09ICdzdHJpbmcnKVxuXHRcdFx0e1xuXHRcdFx0XHRjID0gY2hhbGtbY107XG5cdFx0XHR9XG5cblx0XHRcdGFyciA9IGFyci5tYXAodiA9PiBjKHYpKTtcblx0XHR9XG5cblx0XHRpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PSAnd2luMzInICYmIHRoaXMuZW5hYmxlZENvbG9yKVxuXHRcdHtcblx0XHRcdC8qKlxuXHRcdFx0ICogQEZJWE1FIGZpeCBidWcgb24gd2luZG93cyB3aGVuIGFmdGVyIGJvbGRcblx0XHRcdCAqXG5cdFx0XHQgKiBodHRwczovL2dpdGh1Yi5jb20vY2hhbGsvY2hhbGsvaXNzdWVzLzE0NSNpc3N1ZWNvbW1lbnQtMjg4OTg1OTAzXG5cdFx0XHQgKi9cblx0XHRcdGFyciA9IGFyci5tYXAodiA9PiAnXFx1MDAxQlswbScgKyB2ICsgJ1xcdTAwMUJbMG0nKTtcblx0XHR9XG5cblx0XHRpZiAoIShuYW1lIGluIHRoaXNbU1lNX0NPTlNPTEVdKSlcblx0XHR7XG5cdFx0XHRuYW1lID0gZmFpbEJhY2s7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXNbU1lNX0NPTlNPTEVdW25hbWVdKC4uLmFycik7XG5cdH1cblxuXHRwcm90ZWN0ZWQgX2NoYWxrU3R5bGVNZXRob2QobmFtZSlcblx0e1xuXHRcdHJldHVybiBmdW5jdGlvbiBjaGFsa1N0eWxlTWV0aG9kKC4uLmFyZ3YpXG5cdFx0e1xuXHRcdFx0bGV0IG8gPSB0aGlzLl9jbG9uZSgpO1xuXG5cdFx0XHRvW1NZTV9DSEFMS10gPSB0aGlzW1NZTV9DSEFMS11bbmFtZV0oLi4uYXJndik7XG5cblx0XHRcdHJldHVybiBvO1xuXHRcdH07XG5cdH1cblxuXHRwcm90ZWN0ZWQgX3RpbWUoKVxuXHR7XG5cdFx0cmV0dXJuIERhdGVUaW1lLmxvY2FsKCkudG9Gb3JtYXQoJ1tISDptbTpzcy5TU1NdJyk7XG5cdH1cbn1cblxudXRpbC5pbmhlcml0cyhDb25zb2xlMiwgRnVuY3Rpb24pO1xuXG4vLyBAdHMtaWdub3JlXG5Db25zb2xlMi5wcm90b3R5cGUuQ29uc29sZSA9IENvbnNvbGUyXG5cbnN0eWxlTmFtZXMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSlcbntcblx0aWYgKHN0eWxlTmFtZXNGbi5pbmNsdWRlcyhuYW1lKSlcblx0e1xuXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb25zb2xlMi5wcm90b3R5cGUsIG5hbWUsIHtcblx0XHRcdGdldCgpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiB0aGlzLl9jaGFsa1N0eWxlTWV0aG9kKG5hbWUpO1xuXHRcdFx0fSxcblx0XHR9KTtcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoQ29uc29sZTIucHJvdG90eXBlLCBuYW1lLCB7XG5cdFx0XHRnZXQoKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gdGhpcy5fY2hhbGtTdHlsZVByb3AobmFtZSk7XG5cdFx0XHR9LFxuXHRcdH0pO1xuXHR9XG59KTtcblxuRmlsbFByb3BlcnR5Lm1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbiAobmFtZTogc3RyaW5nKVxue1xuXHRpZiAobmFtZSA9PSAnZGlyJylcblx0e1xuXHRcdENvbnNvbGUyLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIGNoYWxrU3R5bGVMb2dPdGhlcnMob2JqZWN0LCBvcHRpb25zKVxuXHRcdHtcblx0XHRcdGlmICghdGhpcy5lbmFibGVkKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdGlmICghb3B0aW9ucyAmJiB0aGlzW1NZTV9EQVRBXS5pbnNwZWN0T3B0aW9ucylcblx0XHRcdHtcblx0XHRcdFx0b3B0aW9ucyA9IHRoaXNbU1lNX0RBVEFdLmluc3BlY3RPcHRpb25zO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAob3B0aW9ucylcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHRoaXNbU1lNX0NPTlNPTEVdW25hbWVdKG9iamVjdCwgb3B0aW9ucyk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB0aGlzW1NZTV9DT05TT0xFXVtuYW1lXShvYmplY3QpO1xuXHRcdH07XG5cdH1cblx0ZWxzZSBpZiAobmFtZSA9PSAnYXNzZXJ0Jylcblx0e1xuXHRcdENvbnNvbGUyLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIGNoYWxrU3R5bGVMb2dBc3NlcnQodmFsdWUsIC4uLmFyZ3YpXG5cdFx0e1xuXHRcdFx0aWYgKCF0aGlzLmVuYWJsZWQpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0aWYgKCF2YWx1ZSlcblx0XHRcdHtcblx0XHRcdFx0bGV0IG87XG5cdFx0XHRcdGlmIChhcmd2Lmxlbmd0aClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxldCBzID0gdGhpcy5fbG9nRm9ybWF0KC4uLmFyZ3YpO1xuXG5cdFx0XHRcdFx0byA9IHRoaXNbU1lNX0NIQUxLXShzKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gdGhpc1tTWU1fQ09OU09MRV1bbmFtZV0odmFsdWUsIG8pO1xuXHRcdFx0fVxuXHRcdH07XG5cdH1cblx0ZWxzZSBpZiAoRmlsbFByb3BlcnR5Lm1ldGhvZHNfc3Rkb3V0LmluY2x1ZGVzKG5hbWUpKVxuXHR7XG5cdFx0Q29uc29sZTIucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24gY2hhbGtTdHlsZUxvZyguLi5hcmd2KVxuXHRcdHtcblx0XHRcdHJldHVybiB0aGlzLl9sb2cobmFtZSwgYXJndilcblx0XHR9O1xuXHR9XG5cdGVsc2UgaWYgKEZpbGxQcm9wZXJ0eS5tZXRob2RzX3N0ZGVyci5pbmNsdWRlcyhuYW1lKSlcblx0e1xuXHRcdENvbnNvbGUyLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uIGNoYWxrU3R5bGVMb2coLi4uYXJndilcblx0XHR7XG5cdFx0XHRyZXR1cm4gdGhpcy5fbG9nKG5hbWUsIGFyZ3YsICdlcnJvcicpXG5cdFx0fTtcblx0fVxuXHRlbHNlXG5cdHtcblx0XHRDb25zb2xlMi5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiBjaGFsa1N0eWxlTG9nT3RoZXJzKC4uLmFyZ3YpXG5cdFx0e1xuXHRcdFx0aWYgKCF0aGlzLmVuYWJsZWQpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHRoaXNbU1lNX0NPTlNPTEVdW25hbWVdKC4uLmFyZ3YpO1xuXHRcdH07XG5cdH1cbn0pO1xuXG5leHBvcnQgZGVmYXVsdCBDb25zb2xlMlxuIl19